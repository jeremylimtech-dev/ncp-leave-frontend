<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Details</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/ncpicon.ico" type="image/x-icon">
 <link rel="shortcut icon" href="/ncpicon.ico" type="image/x-icon">
</head>
<body>

<div class="container leave-card">
  <h1 class="card-title">Leave Details</h1>

  <!-- Employee -->
  <div class="field-group">
    <label>Employee</label>
    <input type="text" id="employeeName" readonly />
  </div>

  <!-- Leave type -->
  <div class="field-group">
    <label>Leave type</label>
    <div class="leave-options leave-type-options">
      <div class="leave-btn active" onclick="setLeaveType('Sick', this)">
        Sick Leave
      </div>
      <div class="leave-btn" onclick="setLeaveType('Annual', this)">
        Annual Leave
      </div>
      <div class="leave-btn" onclick="setLeaveType('Unpaid', this)">
        Unpaid Leave
      </div>
    </div>
  </div>

  <input type="hidden" id="leaveType" value="Sick">

  <!-- Balance -->
  <div class="field-group">
    <label>Available balance</label>
    <input type="text" id="balance" readonly />
  </div>

  <!-- Dates -->
  <div class="row">
    <div class="field-group">
      <label>Start date</label>
      <input type="date" id="startDate" />
    </div>

    <div class="field-group">
      <label>End date</label>
      <input type="date" id="endDate" />
    </div>
  </div>

  <!-- Hours per day -->
  <div class="field-group">
    <label>Hours per day</label>
    <div class="leave-options hours-options">
      <div class="leave-btn active" onclick="setHours(8, this)">
        Full day<br /><small>8 hours</small>
      </div>
      <div class="leave-btn" onclick="setHours(4, this)">
        Half day<br /><small>4 hours</small>
      </div>
    </div>
  </div>

  <!-- Total -->
  <div class="field-group">
    <label>Total leave hours</label>
    <input type="text" id="totalHours" readonly placeholder="â€”" />
  </div>

  <!-- Reason -->
  <div class="field-group">
    <label>Reason</label>
    <textarea id="reason" placeholder="Brief explanation"></textarea>
  </div>

  <button class="primary-btn" onclick="submitLeave()">Submit</button>

  <p class="hint-text">
    * Sick leave more than 16 hours may require a medical certificate
  </p>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

let hoursPerDay = 8;
let availableBalanceHours = 0;

/* =====================
   INIT (CORRECT)
===================== */
const token = localStorage.getItem("employeeToken");
const name = localStorage.getItem("employeeName");

if (!token || !name) {
  alert("Session expired. Please login again.");
  window.location.replace("employee-login.html");
} else {
  document.getElementById("employeeName").value = name;
  loadBalance(); // ðŸ”¥ THIS WAS NEVER RUNNING BEFORE
}

/* =====================
   SET LEAVE TYPE
===================== */
function setLeaveType(type, btn) {
  leaveType.value = type;

  document
    .querySelectorAll(".leave-type-options .leave-btn")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");
  loadBalance();
}

/* =====================
   LOAD BALANCE
===================== */
async function loadBalance() {
  const token = localStorage.getItem("employeeToken");
  const type = leaveType.value;

  if (type === "Unpaid") {
    availableBalanceHours = Infinity;
    balance.value = "Unpaid Leave: Unlimited";
    calculateTotal();
    return;
  }

  balance.value = "Loadingâ€¦";

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams({
      action: "getEmployeeBalanceSecure",
      token,
      leaveType: type
    })
  });

  const data = await res.json();

  if (!data.success) {
    console.error("Balance error:", data);
    balance.value = "Unable to load balance";
    return;
  }

  availableBalanceHours = data.balanceHours;
  balance.value = `${type} Balance: ${availableBalanceHours} hours`;
  calculateTotal();
}

/* =====================
   HOURS PER DAY
===================== */
function setHours(hours, btn) {
  hoursPerDay = hours;

  document
    .querySelectorAll(".hours-options .leave-btn")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");
  calculateTotal();
}

/* =====================
   TOTAL HOURS
===================== */
["startDate", "endDate"].forEach(id =>
  document.getElementById(id).addEventListener("change", calculateTotal)
);

function calculateTotal() {
  if (!startDate.value || !endDate.value) {
    totalHours.value = "â€”";
    return;
  }

  const s = new Date(startDate.value);
  const e = new Date(endDate.value);

  let days = 0;
  for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
    const day = d.getDay();
    if (day !== 0 && day !== 6) days++;
  }

  totalHours.value = `${days * hoursPerDay} hours`;
}

/* =====================
   SUBMIT
===================== */
let submitting = false;

function submitLeave() {
  // ðŸš« prevent double submit
  if (submitting) return;
  submitting = true;

  const submitBtn = document.querySelector(".primary-btn");

  // basic validation
  if (!startDate.value || !endDate.value || !reason.value.trim()) {
    alert("Please complete all fields.");
    submitting = false;
    return;
  }

  const total = Number(totalHours.value.replace(" hours", ""));
  const type = leaveType.value;

  // ðŸ”„ loading state
  submitBtn.disabled = true;
  submitBtn.innerText = "Submittingâ€¦";
  submitBtn.style.opacity = "0.85";

  // ðŸ’° balance check (paid leaves only)
  if (type !== "Unpaid" && total > availableBalanceHours) {
    alert(
      `Insufficient balance.\n\nRequested: ${total} hours\nAvailable: ${availableBalanceHours} hours`
    );

    submitBtn.disabled = false;
    submitBtn.innerText = "Submit";
    submitBtn.style.opacity = "1";
    submitting = false;
    return;
  }

	const payload = {
	action: "submitLeaveSecure",
	token: localStorage.getItem("employeeToken"),
	leaveType: type,
	startDate: startDate.value,
	endDate: endDate.value,
	hoursPerDay,
	totalHours: total,
	reason: reason.value.trim()
	};


  fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert(data.message || "Submission failed.");

        submitBtn.disabled = false;
        submitBtn.innerText = "Submit";
        submitBtn.style.opacity = "1";
        submitting = false;
        return;
      }

      // âœ… success feedback
      submitBtn.innerText = "Submitted âœ“";
      submitBtn.style.background = "#22c55e";

      setTimeout(() => {
        window.location.href = "submitted.html";
      }, 600);
    })
    .catch(() => {
      alert("Submission failed. Please try again.");

      submitBtn.disabled = false;
      submitBtn.innerText = "Submit";
      submitBtn.style.opacity = "1";
      submitting = false;
    });
}

</script>

</body>
</html>
