<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Login</title>
  <link rel="stylesheet" href="style.css">

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div class="admin-icon" onclick="goAdmin()">Admin</div>

<!-- Branding (Top Left) -->
<div style="position: fixed; top: 20px; left: 30px; z-index: 10;">
  <div class="brand">
    <div class="brand-circle">
      <img src="logo.png" alt="NCP Logo">
    </div>
    <span>NCP Bookkeeping</span>
  </div>
</div>

<div class="container employee-login-card">
  <h1>Employee Login</h1>

  <!-- Google button -->
  <div id="googleBtn" class="google-login-wrapper"></div>

  <p class="login-hint">Sign in using your company email</p>

  <!-- Loading state -->
  <div id="googleLoading" class="google-loading hidden">
    <div class="spinner"></div>
    <p>Signing you inâ€¦</p>
  </div>

  <!-- Helper text -->
  <p class="login-helper">
    Not registered? <span onclick="contactAdmin()">Contact admin</span>
  </p>

  <button class="secondary-btn" onclick="goBack()" style="margin-top: 12px;">
    Back
  </button>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

/* Navigation */
function goBack() {
  if (document.referrer) {
    window.history.back();
  } else {
    window.location.href = "index.html";
  }
}

function goAdmin() {
  window.location.href = "admin-login.html";
}

/* Google Login Callback */
function handleCredentialResponse(response) {
  // show loading
  document.getElementById("googleBtn").classList.add("hidden");
  document.getElementById("googleLoading").classList.remove("hidden");

  verifyEmployee(response.credential);
}

/* Initialize Google Login */
window.onload = function () {
  google.accounts.id.initialize({
    client_id: "14009431850-vkipfmcfkvtql27977rrcoq4e2uuif78.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });

  google.accounts.id.renderButton(
    document.getElementById("googleBtn"),
    {
      theme: "filled_blue",
      size: "large",
      width: 260
    }
  );
};

function contactAdmin() {
  window.location.href = "mailto:admin@ncpbookkeeping.com";
}

/* Send token to Apps Script */
function verifyEmployee(idToken) {
  console.log("TOKEN RECEIVED:", idToken.substring(0, 20));

  const body = new URLSearchParams({
    action: "verifyEmployeeGoogle",
    token: idToken
  });

  fetch(SCRIPT_URL, {
    method: "POST",
    body: body
  })
    .then(res => res.json())
    .then(data => {
      console.log("DEBUG DATA:", data);

      if (!data.success) {
        alert(
          "Login failed:\n" +
          JSON.stringify(data.debug || data, null, 2)
        );
        resetLoginUI();
        return;
      }

      localStorage.setItem("employeeId", data.employee.id);
      localStorage.setItem("employeeName", data.employee.name);
      localStorage.setItem("employeeEmail", data.employee.email);

      window.location.href = "employee-dashboard.html";
    })
    .catch(err => {
      console.error("LOGIN ERROR:", err);
      alert("Login failed. Please try again.");
      resetLoginUI();
    });
}



function resetLoginUI() {
  document.getElementById("googleBtn").classList.remove("hidden");
  document.getElementById("googleLoading").classList.add("hidden");
}
</script>

</body>
</html>