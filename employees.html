<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employees</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="/ncpicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/ncpicon.ico" type="image/x-icon">
</head>
<body>

<div class="admin-icon" onclick="goBack()">Back</div>

<!-- HEADER -->
<div style="position: fixed; top: 20px; left: 30px; z-index: 10;">
  <div class="brand">
    <div class="brand-circle">
      <img src="logo.png" alt="NCP Logo">
    </div>
    <span>Employees</span>
  </div>
</div>

<!-- PAGE LOADING -->
<div id="pageLoader" class="loading-state">
  <div class="page-spinner"></div>
  <div class="loading-text">Loading employees</div>
</div>

<!-- FETCH LOADER -->
<div id="fetchLoader" class="modal-overlay">
  <div class="loading-state">
    <div class="page-spinner"></div>
    <div class="loading-text">Loading employee</div>
  </div>
</div>

<!-- EMPLOYEE GRID -->
<div class="employee-grid" id="employeeGrid" style="display:none;"></div>

<!-- EMPLOYEE MODAL -->
<div class="modal-overlay" id="employeeModal">
  <div class="employee-modal">
    <div class="avatar">
      <img id="modalAvatar" src="default-avatar.png" alt="Avatar">
    </div>

    <h2 id="modalName">Employee</h2>

    <button class="primary-btn" onclick="editEmployee()">Edit Employee</button>
    <button class="primary-btn" onclick="viewStatus()">Status</button>
    <button class="primary-btn" onclick="viewDetails()">Details</button>

    <button class="primary-btn" onclick="closeModal()" style="margin-top:12px;">
      Close
    </button>
  </div>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

function goBack() {
  window.location.href = "admin-dashboard.html";
}

function addEmployee() {
  window.location.href = "add-employee.html";
}

/* =====================
   LOAD EMPLOYEES
===================== */
const pageLoader = document.getElementById("pageLoader");
const grid = document.getElementById("employeeGrid");

fetch(`${SCRIPT_URL}?action=getEmployees`)
  .then(res => res.json())
  .then(data => {
    if (!data.success) throw new Error("Failed to load employees");

    setTimeout(() => {
      pageLoader.style.display = "none";
      grid.style.display = "grid";

      if (data.employees.length === 0) {
        grid.innerHTML = `
          <div class="employee-btn add-employee" onclick="addEmployee()">
            + Add Employee
          </div>
        `;
        return;
      }

      data.employees.forEach(emp => {
        const btn = document.createElement("button");
        btn.className = "employee-btn";
        btn.textContent = emp.name;
        btn.onclick = () => openEmployee(emp.id);
        grid.appendChild(btn);
      });

      const addBtn = document.createElement("button");
      addBtn.className = "employee-btn add-employee";
      addBtn.innerHTML = "âž• Add Employee";
      addBtn.onclick = e => {
        e.stopPropagation();
        addEmployee();
      };

      grid.appendChild(addBtn);
    }, 300);
  })
  .catch(err => {
    pageLoader.querySelector(".loading-text").textContent =
      "Unable to load employees";
    console.error(err);
  });

/* =====================
   EMPLOYEE MODAL
===================== */
let selectedEmployeeId = "";

function openEmployee(id) {
  selectedEmployeeId = id;

  const loader = document.getElementById("fetchLoader");
  const modal = document.getElementById("employeeModal");
  const avatar = document.getElementById("modalAvatar");

  modal.classList.remove("show");
  modal.style.display = "none";

  loader.style.display = "flex";
  loader.classList.add("show");

  fetch(`${SCRIPT_URL}?action=getEmployee&id=${id}`)
    .then(res => res.json())
    .then(data => {
      if (!data.success) throw new Error("Employee not found");

      document.getElementById("modalName").textContent =
        data.employee.name;

      avatar.src =
        data.employee.photo && data.employee.photo.trim()
          ? data.employee.photo
          : "default-avatar.png";

      avatar.onerror = () => {
        avatar.src = "default-avatar.png";
      };

      loader.classList.remove("show");
      setTimeout(() => {
        loader.style.display = "none";
        modal.style.display = "flex";
        requestAnimationFrame(() => modal.classList.add("show"));
      }, 200);
    })
    .catch(err => {
      loader.style.display = "none";
      alert(err.message);
    });
}

function closeModal() {
  const modal = document.getElementById("employeeModal");
  modal.classList.remove("show");
  setTimeout(() => modal.style.display = "none", 250);
}

document.getElementById("employeeModal").addEventListener("click", e => {
  if (e.target.id === "employeeModal") closeModal();
});

function editEmployee() {
  window.location.href =
    `edit-employee.html?id=${selectedEmployeeId}`;
}

function viewStatus() {
  alert("Status feature coming soon");
}

function viewDetails() {
  alert("Details feature coming soon");
}
</script>

</body>
</html>
