<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Leave Details</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container leave-card">
  <h1 class="card-title">Leave Details</h1>

  <div class="field-group">
    <label>Employee</label>
    <input type="text" id="employeeName" readonly />
  </div>

	<div class="field-group">
		<label>Leave type</label>
		<select id="leaveType">
			<option value="Sick">Sick Leave</option>
			<option value="Annual">Annual Leave</option>
		</select>
	</div>

  <div class="field-group">
    <label>Available Balance</label>
    <input type="text" id="balance" readonly />
  </div>

  <div class="row">
    <div class="field-group">
      <label>Start date</label>
      <input type="date" id="startDate" />
    </div>

    <div class="field-group">
      <label>End date</label>
      <input type="date" id="endDate" />
    </div>
  </div>

  <div class="field-group">
    <label>Hours per day</label>
    <div class="leave-options">
      <div class="leave-btn active" onclick="setHours(8, this)">
        Full day<br /><small>8 hours</small>
      </div>
      <div class="leave-btn" onclick="setHours(4, this)">
        Half day<br /><small>4 hours</small>
      </div>
    </div>
  </div>

  <div class="field-group">
    <label>Total leave hours</label>
    <input type="text" id="totalHours" readonly placeholder="—" />
  </div>

  <div class="field-group">
    <label>Reason</label>
    <textarea id="reason" placeholder="Brief explanation"></textarea>
  </div>

  <button class="primary-btn" onclick="submitLeave()">Submit</button>

  <p class="hint-text">
    * Sick leave more than 16 hours may require a medical certificate
  </p>
</div>

<script>
const SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz4zMRShI6IwL7ehez3Q9VX_ysMQb3Otv__59tgoe5-91zfEN1THvLSJjty_TCN24Wp/exec";

let hoursPerDay = 8;
let availableBalanceHours = 0;

/* =====================
   INIT
===================== */
(async function init() {
  const employeeId = localStorage.getItem("employeeId");
  const name = localStorage.getItem("employeeName");
  
  if (!employeeId || !name) {
  alert("Session expired. Please login again.");
  window.location.href = "employee-login.html";
  return;
 }

  employeeName.value = name;
  balance.value = "Loading balance…";

  const res = await fetch(
    `${SCRIPT_URL}?action=getEmployeeBalance&employeeId=${employeeId}&leaveType=${leaveType}`
  );
  const data = await res.json();

  if (!data.success) {
    balance.value = "Unable to load balance";
    return;
  }

  availableBalanceHours = data.balanceHours;
  balance.value = `${leaveType} Balance: ${availableBalanceHours} hours`;
})();

/* =====================
   HOURS PER DAY
===================== */
function setHours(hours, btn) {
  hoursPerDay = hours;

  document
    .querySelectorAll(".leave-btn")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");
  calculateTotal();
}

/* =====================
   TOTAL HOURS CALC
===================== */
["startDate", "endDate"].forEach(id =>
  document.getElementById(id).addEventListener("change", calculateTotal)
);

function calculateTotal() {
  if (!startDate.value || !endDate.value) return;

  const s = new Date(startDate.value);
  const e = new Date(endDate.value);

  let days = 0;
  for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
    const day = d.getDay();
    if (day !== 0 && day !== 6) days++;
  }

  totalHours.value = `${days * hoursPerDay} hours`;
}

/* =====================
   SUBMIT
===================== */
function submitLeave() {
  if (!startDate.value || !endDate.value || !reason.value.trim()) {
    alert("Please complete all fields.");
    return;
  }

  const total = Number(totalHours.value.replace(" hours", ""));

  if (total > availableBalanceHours) {
    alert(
      `Insufficient balance.\n\nRequested: ${total} hours\nAvailable: ${availableBalanceHours} hours`
    );
    return;
  }

  const payload = {
    action: "submitLeave",
    employeeId: localStorage.getItem("employeeId"),
    employeeName: localStorage.getItem("employeeName"),
    leaveType: localStorage.getItem("leaveType"),
    startDate: startDate.value,
    endDate: endDate.value,
    hoursPerDay,
    totalHours: total,
    reason: reason.value.trim()
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams(payload)
  })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert(data.message || "Submission failed.");
        return;
      }
      window.location.href = "submitted.html";
    })
    .catch(() => alert("Submission failed. Please try again."));
}
</script>

</body>
</html>
